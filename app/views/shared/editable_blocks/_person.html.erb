<%- block.identities.build -%>

<%= form_for block.persisted? ? block  : [block.owner, block] do |form| -%>
  
  <%- block.identities.each do |identity| -%>
    <div class="person <%= identity.persisted? ? 'persisted' : 'new' %>">
      <%- if identity.persisted? -%>
        <i class="fa fa-user"></i>
        <%= select_tag :"block[identity_ids][]", options_from_collection_for_select(block.owner.people, :to_param, :full_name, identity.to_param), prompt: 'Delete this person', class: :edit, id: nil, data: { value: identity.to_param } %>
      <%- else -%>
        <%- people = block.owner.people - block.people -%>

        <%- if people.empty? -%>
          <span class="empty">
            No more people
          </span>
        <%- else -%>
          <%= select_tag :"block[identity_ids][]", options_from_collection_for_select(people, :to_param, :full_name), prompt: 'Add person', class: :new, id: nil %>
        <%- end -%>
      <%- end -%>
    </div>
  <%- end -%>
  
<%- end -%>

<%= link_to 'Destroy', block, method: :delete, data: { confirm: 'Are you sure?' } if block.persisted? && !block.is_locked? %>
